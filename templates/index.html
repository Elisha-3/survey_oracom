<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Survey Dashboard - Browns Plantation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jsPDF + autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    .navbar { position: sticky; top: 0; z-index: 1050; }
    #header { position: sticky; top: 56px; z-index: 1040; background-color: #0d6efd; }
    #section1 { background: #f8f9fa; position: sticky; top: 120px; z-index: 1030; border-bottom: 1px solid #ddd; }
    .progress { height: 4px; background-color: #e9ecef; }
    .progress-bar { background-color: #0d6efd; }
  </style>
</head>
<body class="bg-light d-flex flex-column vh-100">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('index') }}">SurveyApp</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          {% if session.get('user_id') %}
            <li class="nav-item">
              <a class="nav-link">Hello, {{ session['username'] }}</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </li>
          {% else %}
            <li class="nav-item">
              <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
            </li>
            <li class="nav-item">
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">Register</button>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="container mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3"><label>Email</label>
              <input type="email" name="email" class="form-control" required>
            </div>
            <div class="mb-3"><label>Password</label>
              <input type="password" name="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-dark w-100">Login</button>
          </form>
          <div id="loginMessage" class="mt-2"></div>

          <!-- Links under login -->
          <div class="text-center mt-3">
            <a href="#" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal" data-bs-dismiss="modal">
              Forgot Password?
            </a>
            <br>
            <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal" data-bs-dismiss="modal">
              Donâ€™t have an account? Register
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">Forgot Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="forgotPasswordForm">
            <div class="form-group mb-2">
              <label for="resetEmail">Enter your email</label>
              <input type="email" class="form-control" name="email" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Send Reset Link</button>
          </form>
          <div id="forgotMessage" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">Reset Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="resetPasswordForm" method="POST">
            <div class="form-group mb-2">
              <label for="password">New Password</label>
              <input type="password" class="form-control" name="password" required>
            </div>
            <div class="form-group mb-2">
              <label for="confirm_password">Confirm Password</label>
              <input type="password" class="form-control" name="confirm_password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Reset Password</button>
          </form>
          <div id="resetMessage" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Register</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="registerForm">
            <div class="mb-3"><label>Username</label>
              <input type="text" name="username" class="form-control" required>
            </div>
            <div class="mb-3"><label>Email</label>
              <input type="email" name="email" class="form-control" required>
            </div>
            <div class="mb-3"><label>Password</label>
              <input type="password" name="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Register</button>
          </form>
          <div id="registerMessage" class="mt-2"></div>

          <!-- Link to go back to login -->
          <div class="text-center mt-3">
            <a href="#" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="modal">
              Already have an account? Login
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container py-5">
    <h2 id="header" class="text-center mb-5 bg-primary text-white p-3">ðŸ“Š Survey Visualization Dashboard</h2>

    <!-- SECTION 1: Upload + Global Filters -->
    <section id="section1" class="card shadow p-3 bg-light border-bottom">
      <h4 class="mb-3">Upload and Filter Data</h4>
      <div class="row g-3 align-items-end">
        <div class="col-12 col-lg-6">
          <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data">
            <div class="row g-2 align-items-center">
              <div class="col-8">
                <input type="file" name="file" class="form-control" required>
              </div>
              <div class="col-4">
                <button type="submit" class="btn btn-primary w-100">Upload</button>
              </div>
            </div>
          </form>
          <div id="responseMessage" class="mt-2 small text-success"></div>
        </div>

        <!-- Filters -->
        <div class="col-6 col-lg-3">
          <label for="efdFilter" class="form-label mb-1">EFD (Department)</label>
          <select id="efdFilter" class="form-select"></select>
        </div>
        <div class="col-6 col-lg-3">
          <label for="jobFilter" class="form-label mb-1">Job Category</label>
          <select id="jobFilter" class="form-select"></select>
        </div>
        <div class="col-6 col-lg-3">
          <label for="empFilter" class="form-label mb-1">Employment Status</label>
          <select id="empFilter" class="form-select"></select>
        </div>
        <div class="col-6 col-lg-3">
          <label for="sexFilter" class="form-label mb-1">Sex</label>
          <select id="sexFilter" class="form-select"></select>
        </div>
      </div>
    </section>

    <!-- SECTION 2: Data Table -->
    <main class="flex-grow-1 overflow-auto">
    <section class="card shadow p-4 mb-5">
      <h4>Responses Table</h4>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="dropdown">
          <button class="btn btn-success dropdown-toggle" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Download
          </button>
          <ul class="dropdown-menu" aria-labelledby="downloadDropdown">
            <li><button class="dropdown-item" onclick="downloadFile('csv')">CSV</button></li>
            <li><button class="dropdown-item" onclick="downloadFile('excel')">Excel</button></li>
            <li><button class="dropdown-item" onclick="downloadFile('pdf')">PDF</button></li>
          </ul>
        </div>
      </div>
      <div class="table-responsive">
        <table id="responseTable" class="table table-striped table-bordered align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>EFD</th>
              <th>Phone Number</th>
              <th>Job Category</th>
              <th>Employment Status</th>
              <th>Sex</th>
              <th>Status</th>
              <th>Reason</th>
              <th>Q1</th>
              <th>Q2</th>
              <th>Q3</th>
            </tr>
          </thead>
          <tbody id="dataTableBody"></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="d-flex align-items-center">
          <button id="prevPage" class="btn btn-outline-primary" disabled>&lt; Back</button>
          <span id="pageInfo" class="ms-3">Page 1 of 1</span>
        </div>
        <div class="flex-grow-1 mx-3">
          <div class="progress">
            <div class="progress-bar" style="width: 0%;"></div>
          </div>
        </div>
        <div class="d-flex align-items-center">
          <select id="limitSelect" class="form-select w-auto">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="500">500</option>
            <option value="1000">1000</option>
          </select>
          <span class="ms-2">Rows per page</span>
        </div>
        <button id="nextPage" class="btn btn-primary ms-3">Next &gt;</button>
      </div>
    </section>

    <!-- SECTION 3: Q1 Visualization -->
    <section class="card shadow p-4 mb-5">
      <div class="d-flex justify-content-between flex-wrap gap-2">
        <h4 class="mb-0">Q1 Responses (Visualization)</h4>
        <div class="small text-muted" id="filterBadge"></div>
      </div>

      <!-- Quick Stat -->
      <div class="row mt-3">
        <div class="col-md-4">
          <div class="p-3 rounded bg-white border">
            <div class="fw-semibold mb-1">Q1 Respondents by Sex</div>
            <div class="d-flex gap-3">
              <div>â™‚ Male: <span id="malePct">0%</span></div>
              <div>â™€ Female: <span id="femalePct">0%</span></div>
              <div>Total Q1: <span id="totalQ1">0</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="row mt-3">
        <div class="col-md-6 mb-4">
          <canvas id="donutChart"></canvas>
        </div>
        <div class="col-md-6 mb-4">
          <canvas id="barChart"></canvas>
        </div>
      </div>
    </section>

    <!-- SECTION 4: Q2/Q3 text --- pagination -->
    <section class="card shadow p-4">
      <div class="row">
        <div class="col-md-6">
          <h5>Q2 Responses</h5>
          <ul id="q2Text" class="list-group"></ul>
          <div class="mt-2 d-flex justify-content-between">
            <button id="prevQ2" class="btn btn-sm btn-secondary">Previous</button>
            <span id="q2PageInfo">Page 1</span>
            <button id="nextQ2" class="btn btn-sm btn-secondary">Next</button>
          </div>
        </div>
        <div class="col-md-6">
          <h5>Q3 Responses</h5>
          <ul id="q3Text" class="list-group"></ul>
          <div class="mt-2 d-flex justify-content-between">
            <button id="prevQ3" class="btn btn-sm btn-secondary">Previous</button>
            <span id="q3PageInfo">Page 1</span>
            <button id="nextQ3" class="btn btn-sm btn-secondary">Next</button>
          </div>
        </div>
      </div>
    </section>
    </main>
  </div>

  <script>
    function downloadFile(format) {
      const f = currentFilters();
      const params = new URLSearchParams({
        format,
        page: 'all',
        efd: f.efd,
        job_category: f.job_category,
        employment_status: f.employment_status,
        sex: f.sex
      });
      window.location.href = `/download?${params.toString()}`;
    }

    let currentPage = 1;
    let limit = 10;
    let donutChart, barChart;

    // Q2/Q3 pagination
    let q2Page = 1, q3Page = 1;
    const q23Limit = 5;

    document.addEventListener('DOMContentLoaded', async () => {
      await populateFilters();
      $('#limitSelect').val(limit);
      attachEvents();
      loadData();
    });

    async function populateFilters() {
      try {
        const res = await fetch('/api/options');
        const opts = await res.json();
        fillSelect('efdFilter', opts.efd);
        fillSelect('jobFilter', opts.job_category);
        fillSelect('empFilter', opts.employment_status);
        fillSelect('sexFilter', opts.sex);
      } catch (e) {
        console.error('Error loading filter options', e);
      }
    }

    function fillSelect(id, values) {
      const sel = document.getElementById(id);
      sel.innerHTML = '';
      const allOpt = document.createElement('option');
      allOpt.value = '';
      allOpt.textContent = 'All';
      sel.appendChild(allOpt);
      (values || []).forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });
    }

    function currentFilters() {
      return {
        efd: document.getElementById('efdFilter').value || '',
        job_category: document.getElementById('jobFilter').value || '',
        employment_status: document.getElementById('empFilter').value || '',
        sex: document.getElementById('sexFilter').value || ''
      };
    }

    function attachEvents() {
      // Upload
      $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        $('#responseMessage').text('Uploading...').removeClass().addClass('mt-2 text-info');
        $.ajax({
          url: '/upload', type: 'POST', data: formData, contentType: false, processData: false,
          success: function(response) {
            $('#responseMessage').text(response.message).removeClass().addClass('mt-2 text-success');
            populateFilters().then(loadData);
          },
          error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Upload failed';
            $('#responseMessage').text(error).removeClass().addClass('mt-2 text-danger');
          }
        });
      });

      // Filters reload
      ['efdFilter','jobFilter','empFilter','sexFilter'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
          currentPage = 1;
          q2Page = 1;
          q3Page = 1;
          loadData();
        });
      });

      // Table pagination
      $('#prevPage').on('click', () => { if (currentPage > 1) { currentPage--; loadData(); } });
      $('#nextPage').on('click', () => { currentPage++; loadData(); });

      // Rows per page change
      $('#limitSelect').on('change', function() {
        limit = parseInt($(this).val());
        currentPage = 1;
        loadData();
      });

      // Q2/Q3 pagination
      $('#prevQ2').on('click', () => { if (q2Page > 1) { q2Page--; loadData(); } });
      $('#nextQ2').on('click', () => { q2Page++; loadData(); });
      $('#prevQ3').on('click', () => { if (q3Page > 1) { q3Page--; loadData(); } });
      $('#nextQ3').on('click', () => { q3Page++; loadData(); });

      // Login form AJAX
      $('#loginForm').on('submit', function(e) {
        e.preventDefault();
        const formData = $(this).serialize();
        $('#loginMessage').text('Logging in...').removeClass().addClass('text-info');
        $.ajax({
          url: '/login',
          type: 'POST',
          data: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          success: function(response) {
            if (response.success) {
              $('#loginMessage').text('Logged in successfully.').removeClass().addClass('text-success');
              setTimeout(() => {
                $('#loginModal').modal('hide');
                location.reload();
              }, 1000);
            } else {
              $('#loginMessage').text(response.error).removeClass().addClass('text-danger');
            }
          },
          error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Login failed';
            $('#loginMessage').text(error).removeClass().addClass('text-danger');
          }
        });
      });

      // Register form AJAX
      $('#registerForm').on('submit', function(e) {
        e.preventDefault();
        const formData = $(this).serialize();
        $('#registerMessage').text('Registering...').removeClass().addClass('text-info');
        $.ajax({
          url: '/register',
          type: 'POST',
          data: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          success: function(response) {
            if (response.success) {
              $('#registerMessage').text('Registration successful. Please log in.').removeClass().addClass('text-success');
              setTimeout(() => {
                $('#registerModal').modal('hide');
                location.reload();
              }, 1000);
            } else {
              $('#registerMessage').text(response.error).removeClass().addClass('text-danger');
            }
          },
          error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Registration failed';
            $('#registerMessage').text(error).removeClass().addClass('text-danger');
          }
        });
      });

      // Forgot Password AJAX
      $('#forgotPasswordForm').on('submit', function(e) {
        e.preventDefault();
        const formData = $(this).serialize();
        $('#forgotMessage').text('Sending reset link...').removeClass().addClass('text-info');
        $.ajax({
          url: '/forgot_password',
          type: 'POST',
          data: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          success: function(response) {
            if (response.success) {
              $('#forgotMessage').text(response.message).removeClass().addClass('text-success');
              setTimeout(() => {
                $('#forgotPasswordModal').modal('hide');
              }, 2000);
            } else {
              $('#forgotMessage').text(response.error).removeClass().addClass('text-danger');
            }
          },
          error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Request failed';
            $('#forgotMessage').text(error).removeClass().addClass('text-danger');
          }
        });
      });

      // Reset Password AJAX
      $('#resetPasswordForm').on('submit', function(e) {
        e.preventDefault();
        const formData = $(this).serialize();
        $('#resetMessage').text('Resetting password...').removeClass().addClass('text-info');
        $.ajax({
          url: $(this).attr('action'),
          type: 'POST',
          data: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          success: function(response) {
            if (response.success) {
              $('#resetMessage').text(response.message).removeClass().addClass('text-success');
              setTimeout(() => {
                $('#resetPasswordModal').modal('hide');
                location.reload();
              }, 1000);
            } else {
              $('#resetMessage').text(response.error).removeClass().addClass('text-danger');
            }
          },
          error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Reset failed';
            $('#resetMessage').text(error).removeClass().addClass('text-danger');
          }
        });
      });
    }

    window.onload = function() {
      const params = new URLSearchParams(window.location.search);

      // Case 1: token exists â†’ open reset modal
      if (params.has("token")) {
        var resetModal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
        resetModal.show();
        document.getElementById("resetPasswordForm").action = "/reset_password/" + params.get("token");
      }

      // Case 2: reset success â†’ open login modal automatically
      if (params.has("reset") && params.get("reset") === "success") {
        var loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        loginModal.show();
      }
    };

    function buildApiUrl() {
      const f = currentFilters();
      const params = new URLSearchParams({
        page: currentPage, limit: limit,
        q2_page: q2Page, q2_limit: q23Limit,
        q3_page: q3Page, q3_limit: q23Limit,
        efd: f.efd, job_category: f.job_category,
        employment_status: f.employment_status, sex: f.sex
      });
      return `/api/data?${params.toString()}`;
    }

    function loadData() {
      const url = buildApiUrl();
      $.get(url, function(data) {
        // render main table
        $('#dataTableBody').html((data.table_data || []).map(row => `
          <tr>
            <td>${row.id ?? ''}</td>
            <td>${row.efd ?? ''}</td>
            <td>${row.phone_number ?? ''}</td>
            <td>${row.job_category ?? ''}</td>
            <td>${row.employment_status ?? ''}</td>
            <td>${row.sex ?? ''}</td>
            <td>${row.status ?? ''}</td>
            <td>${row.reason ?? ''}</td>
            <td>${row.q1 ?? ''}</td>
            <td>${row.q2 ?? ''}</td>
            <td>${row.q3 ?? ''}</td>
          </tr>
        `).join(''));

        const total = data.total || 0;
        const totalPages = Math.ceil(total / limit) || 1;
        $('#pageInfo').text(`Page ${data.page} of ${totalPages}`);
        $('#prevPage').prop('disabled', data.page <= 1);
        $('#nextPage').prop('disabled', data.page >= totalPages);

        const progress = totalPages > 1 ? ((data.page - 1) / (totalPages - 1) * 100) : 0;
        $('.progress-bar').css('width', `${progress}%`);

        // charts + stats
        const sexPct = data.sex_percentages_for_q1 || { male_pct: 0, female_pct: 0, total_q1_responses: 0 };
        $('#malePct').text(`${sexPct.male_pct}%`);
        $('#femalePct').text(`${sexPct.female_pct}%`);
        $('#totalQ1').text`${sexPct.total_q1_responses}`;

        const labels = Object.keys(data.q1_counts || {});
        const values = Object.values(data.q1_counts || {});
        if (donutChart) donutChart.destroy();
        if (barChart) barChart.destroy();
        donutChart = new Chart(document.getElementById('donutChart'), {
          type: 'pie',
          data: { labels, datasets: [{ data: values }] }
        });
        barChart = new Chart(document.getElementById('barChart'), {
          type: 'bar',
          data: { labels, datasets: [{ label: 'Count', data: values }] }
        });

        // Q2/Q3 text with pagination
        $('#q2Text').html((data.q2 || []).map(item => `<li class="list-group-item">${item}</li>`).join(''));
        $('#q3Text').html((data.q3 || []).map(item => `<li class="list-group-item">${item}</li>`).join(''));

        $('#q2PageInfo').text(`Page ${q2Page} of ${data.q2_total_pages || 1}`);
        $('#q3PageInfo').text(`Page ${q3Page} of ${data.q3_total_pages || 1}`);

        $('#prevQ2').prop('disabled', q2Page <= 1);
        $('#nextQ2').prop('disabled', (q2Page * q23Limit) >= (data.q2_total || 0));

        $('#prevQ3').prop('disabled', q3Page <= 1);
        $('#nextQ3').prop('disabled', (q3Page * q23Limit) >= (data.q3_total || 0));
      });
    }
  </script>
  <footer class="bg-light text-center py-3">
    <p class="mb-0">Â© 2025 Browns Plantation Survey Visualization Dashboard | Powered by <a href="https://elmoneltech.netlify.app">Elmoneltech</a></p>
  </footer>
</body>
</html>