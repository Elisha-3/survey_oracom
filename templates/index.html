<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Survey Dashboard - Oracom</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">

  <div class="container py-5">
    <h2 class="text-center mb-5">ðŸ“Š Survey Visualization Dashboard</h2>

    <!-- SECTION 1: Upload Form and Filter -->
    <section class="card shadow p-4 mb-5">
      <h4>Upload and Filter Data</h4>
      <div class="row g-2 align-items-center mb-3">
        <div class="col-md-8">
          <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data">
            <div class="row g-2 align-items-center">
              <div class="col-md-9">
                <input type="file" name="file" class="form-control" required>
              </div>
              <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">Upload</button>
              </div>
            </div>
          </form>
        </div>
        <div class="col-md-4">
          <select id="sexFilter" class="form-select" onchange="loadData()">
            <option value="">All</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>
      </div>
      <div id="responseMessage" class="mt-3 text-success"></div>
    </section>

    <!-- SECTION 2: Table Data -->
    <section class="card shadow p-4 mb-5">
      <h4>Survey Data Table</h4>
      <div class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>ID</th>
              <th>Phone Number</th>
              <th>EFD</th>
              <th>Job Category</th>
              <th>Employment Status</th>
              <th>Sex</th>
              <th>Status</th>
              <th>Reason</th>
              <th>Q1</th>
              <th>Q2</th>
              <th>Q3</th>
            </tr>
          </thead>
          <tbody id="dataTableBody">
            <!-- Data will be populated here -->
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between mt-3">
        <button id="prevPage" class="btn btn-secondary" disabled>Previous</button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage" class="btn btn-secondary">Next</button>
      </div>
    </section>

    <!-- SECTION 3: Q1 Graphs -->
    <section class="card shadow p-4 mb-5">
      <h4>Q1 Responses (Visualization)</h4>
      <div class="row mt-3">
        <div class="col-md-6 mb-4">
          <canvas id="donutChart" width="400" height="400"></canvas>
        </div>
        <div class="col-md-6 mb-4">
          <canvas id="barChart" width="400" height="400"></canvas>
        </div>
      </div>
    </section>

    <!-- SECTION 4: Q2 and Q3 Text Responses -->
    <section class="card shadow p-4">
      <div class="row">
        <div class="col-md-6">
          <h5>Q2 Responses</h5>
          <ul id="q2Text" class="list-group">
            <li class="list-group-item">Loading...</li>
          </ul>
        </div>
        <div class="col-md-6">
          <h5>Q3 Responses</h5>
          <ul id="q3Text" class="list-group">
            <li class="list-group-item">Loading...</li>
          </ul>
        </div>
      </div>
    </section>
  </div>

  <script>
    let currentPage = 1;
    const limit = 10;

    // Handle upload form submission
    $('#uploadForm').on('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      $('#responseMessage').text('Uploading...').removeClass('text-danger').addClass('text-info');
      $.ajax({
        url: '/upload',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        success: function(response) {
          $('#responseMessage').text(response.message).removeClass('text-info text-danger').addClass('text-success');
          loadData(); // Reload data after successful upload
        },
        error: function(xhr) {
          const error = xhr.responseJSON ? xhr.responseJSON.error : 'Upload failed';
          $('#responseMessage').text(error).removeClass('text-info text-success').addClass('text-danger');
        }
      });
    });

    // Load all data: table, charts, and text with filter and pagination
    function loadData() {
      const sexFilter = $('#sexFilter').val();
      let url = `/api/data?page=${currentPage}&limit=${limit}`;
      if (sexFilter) {
        url += `&sex=${sexFilter}`;
      }

      $.get(url, function(data) {
        // Update table
        $('#dataTableBody').html(data.table_data.map(row => `
          <tr>
            <td>${row.id || ''}</td>
            <td>${row.phone_number || ''}</td>
            <td>${row.efd || ''}</td>
            <td>${row.job_category || ''}</td>
            <td>${row.employment_status || ''}</td>
            <td>${row.sex || ''}</td>
            <td>${row.status || ''}</td>
            <td>${row.reason || ''}</td>
            <td>${row.q1 || ''}</td>
            <td>${row.q2 || ''}</td>
            <td>${row.q3 || ''}</td>
          </tr>
        `).join(''));

        // Update pagination
        $('#pageInfo').text(`Page ${data.page}`);
        $('#prevPage').prop('disabled', data.page <= 1);
        $('#nextPage').prop('disabled', (data.page * data.limit) >= data.total);

        // Destroy existing charts to avoid overlap
        if (window.donutChart) window.donutChart.destroy();
        if (window.barChart) window.barChart.destroy();

        // Donut Chart (Q1 Distribution)
        const donutCtx = document.getElementById('donutChart').getContext('2d');
        window.donutChart = new Chart(donutCtx, {
          type: 'pie',
          data: {
            labels: ['Q1', 'Q2', 'Q3'],
            datasets: [{
              label: 'Q1 Distribution',
              data: [data.q1_dist.Q1 * 100, data.q1_dist.Q2 * 100, data.q1_dist.Q3 * 100],
              backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: `Q1 Responses (Sex: ${sexFilter || 'All'})` },
              legend: { position: 'bottom' }
            }
          }
        });

        // Bar Chart (Q1 Counts)
        const barCtx = document.getElementById('barChart').getContext('2d');
        window.barChart = new Chart(barCtx, {
          type: 'bar',
          data: {
            labels: Object.keys(data.q1_counts),
            datasets: [{
              label: 'Count',
              data: Object.values(data.q1_counts),
              backgroundColor: '#36A2EB'
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Count' } } },
            plugins: { legend: { display: false } }
          }
        });

        // Q2 and Q3 Text
        $('#q2Text').html(data.q2.map(item => `<li class="list-group-item">${item}</li>`).join(''));
        $('#q3Text').html(data.q3.map(item => `<li class="list-group-item">${item}</li>`).join(''));
      }).fail(function(xhr) {
        console.error('Error loading data:', xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText);
      });
    }

    // Pagination buttons
    $('#prevPage').on('click', function() {
      if (currentPage > 1) {
        currentPage--;
        loadData();
      }
    });

    $('#nextPage').on('click', function() {
      currentPage++;
      loadData();
    });

    // Initial load
    loadData();
  </script>
</body>
</html>